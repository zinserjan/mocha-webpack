
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Code coverage Â· mocha-webpack</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ide-integration.html" />
    
    
    <link rel="prev" href="jsdom.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Table of Contents</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../installation/setup.html">
            
                <a href="../installation/setup.html">
            
                    
                    Installation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../installation/cli-usage.html">
            
                <a href="../installation/cli-usage.html">
            
                    
                    CLI Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../installation/webpack-configuration.html">
            
                <a href="../installation/webpack-configuration.html">
            
                    
                    Webpack Configuration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Guides
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="jsdom.html">
            
                <a href="jsdom.html">
            
                    
                    JSDOM
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2" data-path="code-coverage.html">
            
                <a href="code-coverage.html">
            
                    
                    Code coverage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="ide-integration.html">
            
                <a href="ide-integration.html">
            
                    
                    IDE Integration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../CONTRIBUTING.html">
            
                <a href="../../CONTRIBUTING.html">
            
                    
                    Contributing Guide
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Code coverage</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="code-coverage-with-mocha-webpack"><a name="code-coverage-with-mocha-webpack" class="plugin-anchor" href="#code-coverage-with-mocha-webpack"><i class="fa fa-link" aria-hidden="true"></i></a>Code Coverage with mocha-webpack</h1>
<p>This guide will show you how to setup code coverage with mocha-webpack and get a report like the following.</p>
<p><img src="../media/code-coverage-report.png" alt="code coverage report">
  <em>Yes, this is a very poor sample report for just two files...</em></p>
<p>For a generic setup that works with Babel, TypeScript and others, you just need the following tools:</p>
<ul>
<li><code>nyc</code>: CLI for istanbul that collects coverage data &amp; generates coverage reports</li>
<li><code>istanbul-instrumenter-loader</code>: Loader that wraps your code with hooks to track coverage when your code get&apos;s executed.</li>
</ul>
<p>First of all we install both with</p>
<pre class="language-"><code class="lang-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev nyc istanbul-instrumenter-loader
</code></pre>
<p>Then your package.json should contain the installed modules.</p>
<p><strong>package.json</strong></p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  ...
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;cross-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.1.4&quot;</span><span class="token punctuation">,</span>
    ...
    <span class="token property">&quot;istanbul-instrumenter-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.2.0&quot;</span><span class="token punctuation">,</span>
    ...
    <span class="token property">&quot;nyc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.0.0&quot;</span><span class="token punctuation">,</span>
    ...
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre>
<p><em>Note:</em> <a href="https://github.com/kentcdodds/cross-env" target="_blank">cross-env</a> is here also installed, which set environment variables across platforms.</p>
<p>As second step we define a npm script to run our tests with code coverage.</p>
<p><strong>package.json</strong></p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mocha-webpack --watch&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test-ci&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mocha-webpack&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;cover&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=coverage nyc --reporter=lcov --reporter=text npm run test-ci&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This allows us to get coverage reports of our codebase with the command <code>npm run cover</code>.</p>
<p><em>Note:</em> mocha-webpack in this sample is preconfigured via the <code>mocha-webpack.opts</code> file.</p>
<p>As next we need to configure <code>nyc</code> within our package.json:</p>
<p><strong>package.json</strong></p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
  ...
  <span class="token property">&quot;nyc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;include&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;src/**/*.js&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instrument&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   ...
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><code>include</code> contains pattern for the location of your source files. Only the files that are listed in this list, are covered.</li>
<li><code>instrument: false</code> stops nyc from instrumenting your code, that&apos;s the task of loader</li>
<li><code>sourceMap: false</code> is disabled for the same reason like <code>instrument</code></li>
</ul>
<p>When you start <code>npm run cover</code> now, you get something like this:</p>
<p><img src="../media/code-coverage-cli-unknown.png" alt="code coverage unknown files"></p>
<p>Now it&apos;s time to setup <code>istanbul-instrumenter-loader</code> to get proper code coverage reports. You just need to add <code>istanbul-instrumenter-loader</code> to the loaders list in your webpack configuration.</p>
<p><strong>webpack.config-test.js</strong></p>
<pre class="language-"><code class="lang-javascript"><span class="token keyword">var</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;webpack-node-externals&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> isCoverage <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">&apos;coverage&apos;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// use absolute paths in sourcemaps (important for debugging via IDE)</span>
    devtoolModuleFilenameTemplate<span class="token punctuation">:</span> <span class="token string">&apos;[absolute-resource-path]&apos;</span><span class="token punctuation">,</span>
    devtoolFallbackModuleFilenameTemplate<span class="token punctuation">:</span> <span class="token string">&apos;[absolute-resource-path]?[hash]&apos;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
      isCoverage <span class="token operator">?</span> <span class="token punctuation">{</span>
          test<span class="token punctuation">:</span> <span class="token regex">/\.(js|ts)/</span><span class="token punctuation">,</span>
          include<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&apos;src&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// instrument only testing sources with Istanbul, after ts-loader runs</span>
          loader<span class="token punctuation">:</span> <span class="token string">&apos;istanbul-instrumenter-loader&apos;</span>
      <span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          test<span class="token punctuation">:</span> <span class="token regex">/.js$/</span><span class="token punctuation">,</span>
          exclude<span class="token punctuation">:</span> <span class="token regex">/(node_modules|bower_components)/</span><span class="token punctuation">,</span>
          loader<span class="token punctuation">:</span> <span class="token string">&apos;babel-loader&apos;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          test<span class="token punctuation">:</span> <span class="token regex">/\.ts$/</span><span class="token punctuation">,</span>
          exclude<span class="token punctuation">:</span> <span class="token regex">/(node_modules|bower_components)/</span><span class="token punctuation">,</span>
          loader<span class="token punctuation">:</span> <span class="token string">&apos;ts-loader&apos;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  target<span class="token punctuation">:</span> <span class="token string">&apos;node&apos;</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// webpack should compile node compatible code</span>
  externals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// in order to ignore all modules in node_modules folder</span>
  devtool<span class="token punctuation">:</span> <span class="token string">&quot;inline-cheap-module-source-map&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>In this config we add <code>istanbul-instrumenter-loader</code> only when we want coverage reports. The loader must be the first entry in the loaders array to ensure that it gets applied as last.
Alternatively you can also use the <a href="https://webpack.js.org/configuration/module/#rule-enforce" target="_blank"><code>enforce</code> option</a>.</p>
<p>Another important detail is that the <code>include</code> option should be configured in the same way (but webpack compatible) as in the <code>package.json</code>. <code>istanbul-instrumenter-loader</code> does not respect the value in the package.json, that&apos;s why you need to configure it again.</p>
<p>When you run <code>npm run cover</code> again you should see something like this - dependent on your code:</p>
<p><img src="../media/code-coverage-cli-success.png" alt="code coverage success"></p>
<p>And you should get an html report (located at <code>./coverage/lcov-report/index.html</code>) that looks like the one from the intro.</p>
<h2 id="generate-coverage-reports-for-the-whole-codebase"><a name="generate-coverage-reports-for-the-whole-codebase" class="plugin-anchor" href="#generate-coverage-reports-for-the-whole-codebase"><i class="fa fa-link" aria-hidden="true"></i></a>Generate coverage reports for the whole codebase</h2>
<p>Only files that were executed within your test run generate code coverage reports. Normally you start your tests with just the test files as entries.</p>
<p>But when you want code coverage reports for the whole codebase, you need to import the rest of the code. It happens very often, that some files doesn&apos;t have any tests and doesn&apos;t impact the code coverage negatively.</p>
<p>That&apos;s not the desired behavour.</p>
<p>Let&apos;s assume that we have a directory for source files with name <code>src</code> and a folder for tests with name <code>test</code> in the project root, like the following:</p>
<pre class="language-"><code>project
  - src
    - module1.js
    - module2.js
  - test
    - module1.test.js
</code></pre><p>As you can see we have two files <code>module1.js</code> and <code>module2.js</code> in our <code>src</code> folder. And more important only <code>module1.js</code> has a related unit test file. <code>module2.js</code> doesn&apos;t have any tests.</p>
<p>When we run our tests now with the following command...</p>
<pre class="language-"><code class="lang-bash">$ mocha-webpack <span class="token string">&quot;test/**/*.js&quot;</span>
</code></pre>
<p>... <code>module2.js</code> will never be executed.</p>
<p>To fix this we add another entry to make sure that all source files are imported:</p>
<pre class="language-"><code class="lang-bash">$ mocha-webpack <span class="token string">&quot;src/**/*.js&quot;</span> <span class="token string">&quot;test/**/*.js&quot;</span>
</code></pre>
<p><strong>Note:</strong> It&apos;s recommended to have a CI configuration that imports all <em>source</em> + <em>test</em> files and for developing it&apos;s best to import only the tests cause importing code that will never execute causes unnecessary compile time.</p>

                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="jsdom.html" class="navigation navigation-prev " aria-label="Previous page: JSDOM">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ide-integration.html" class="navigation navigation-next " aria-label="Next page: IDE Integration">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Code coverage","level":"1.3.2","depth":2,"next":{"title":"IDE Integration","level":"1.3.3","depth":2,"path":"docs/guides/ide-integration.md","ref":"docs/guides/ide-integration.md","articles":[]},"previous":{"title":"JSDOM","level":"1.3.1","depth":2,"path":"docs/guides/jsdom.md","ref":"docs/guides/jsdom.md","articles":[]},"dir":"ltr"},"config":{"plugins":["edit-link","-search","github","anchors","prism","-highlight"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"edit-link":{"label":"Edit This Page","base":"https://github.com/zinserjan/mocha-webpack/tree/master"},"github":{"url":"https://github.com/zinserjan/mocha-webpack"},"anchors":{},"prism":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"mocha-webpack","gitbook":"3.2.2","description":"mocha cli with webpack support"},"file":{"path":"docs/guides/code-coverage.md","mtime":"2018-03-19T00:30:08.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2018-03-21T20:39:27.251Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

